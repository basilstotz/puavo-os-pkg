#!/bin/sh

set -eu

puavo_pkg=${1:-}

if [ -z "$puavo_pkg" ]; then
  echo "Usage: $(basename $0) puavo-pkg" >&2
  exit 1
fi

pkg_installer_sha384sum=$(
  find "$puavo_pkg" -type f ! -name .puavo-pkg-version \
    | sort | xargs -n 1 sha384sum \
    | sha384sum)

if [ ! -e "${puavo_pkg}/.puavo-pkg-version" ]; then
  cat <<EOF > "${puavo_pkg}/.puavo-pkg-version"
pkg-format 1
sha384sum ${pkg_installer_sha384sum}
version 1
EOF
else
  awk -v new_sha384sum="$pkg_installer_sha384sum" '
    $1 == "sha384sum" { $2 = new_sha384sum; bump_version = 1 }
    $1 == "version" && bump_version { $2 += 1 }
  ' "${puavo_pkg}/.puavo-pkg-version" > "${puavo_pkg}/.puavo-pkg-version.tmp"
  mv "${puavo_pkg}/.puavo-pkg-version.tmp" "${puavo_pkg}/.puavo-pkg-version"
fi
